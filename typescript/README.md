# TypeScript å­¦ä¹ ç¬”è®°

## Import Defer (TypeScript 5.9)

### ğŸ¯ ä»€ä¹ˆæ˜¯ Import Deferï¼Ÿ

`import defer` æ˜¯ TypeScript 5.9 å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œå®ƒå…è®¸ä½ å¯¼å…¥ä¸€ä¸ªæ¨¡å—ï¼Œä½†ä¸ç«‹å³æ‰§è¡Œè¯¥æ¨¡å—çš„ä»£ç ã€‚æ¨¡å—åªæœ‰åœ¨ç¬¬ä¸€æ¬¡è®¿é—®å…¶å¯¼å‡ºå†…å®¹æ—¶æ‰ä¼šè¢«æ‰§è¡Œã€‚

### ğŸ“– è¯­æ³•

```typescript
// åªæ”¯æŒå‘½åç©ºé—´å¯¼å…¥
import defer * as module from "./some-module.js";

// âŒ ä¸æ”¯æŒå‘½åå¯¼å…¥
// import defer { someFunction } from "./module.js";

// âŒ ä¸æ”¯æŒé»˜è®¤å¯¼å…¥  
// import defer defaultExport from "./module.js";
```

### ğŸ’¡ æ ¸å¿ƒç‰¹ç‚¹

1. **å»¶è¿Ÿæ‰§è¡Œ**ï¼šæ¨¡å—ä»£ç ä¸ä¼šåœ¨ import æ—¶æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡è®¿é—®æ¨¡å—å±æ€§æ—¶æ‰§è¡Œ
2. **ç«‹å³åŠ è½½**ï¼šæ¨¡å—æ–‡ä»¶ä¼šç«‹å³åŠ è½½ï¼Œåªæ˜¯ä¸æ‰§è¡Œ
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘å¯åŠ¨æ—¶é—´ï¼Œç‰¹åˆ«é€‚åˆæ¡ä»¶æ€§ä½¿ç”¨çš„æ¨¡å—

### ğŸ” Demo è¯´æ˜

#### Demo 1: ä¸ä½¿ç”¨ defer çš„æƒ…å†µ
- æ–‡ä»¶ï¼š`demo1-without-defer.ts`
- æ¼”ç¤ºï¼šæ™®é€š import ä¼šç«‹å³æ‰§è¡Œæ¨¡å—çš„æ‰€æœ‰åˆå§‹åŒ–ä»£ç 
- é—®é¢˜ï¼šå³ä½¿ç¨åæ‰ä½¿ç”¨ï¼Œæ¨¡å—ä¹Ÿä¼šåœ¨å¯åŠ¨æ—¶æ‰§è¡Œï¼Œæ‹–æ…¢å¯åŠ¨é€Ÿåº¦

#### Demo 2: ä½¿ç”¨ defer çš„æƒ…å†µ  
- æ–‡ä»¶ï¼š`demo2-with-defer.ts`
- æ¼”ç¤ºï¼šä½¿ç”¨ `import defer` å»¶è¿Ÿæ¨¡å—æ‰§è¡Œ
- ä¼˜åŠ¿ï¼šåº”ç”¨å¯åŠ¨æ›´å¿«ï¼Œæ¨¡å—åªåœ¨çœŸæ­£éœ€è¦æ—¶æ‰æ‰§è¡Œ

#### Demo 3: æ¡ä»¶åŠ è½½åœºæ™¯
- æ–‡ä»¶ï¼š`demo3-conditional-loading.ts`
- æ¼”ç¤ºï¼šæ ¹æ®ç‰¹æ€§å¼€å…³æ¡ä»¶æ€§åŠ è½½åŠŸèƒ½æ¨¡å—
- åœºæ™¯ï¼šå¦‚æœåŠŸèƒ½æœªå¯ç”¨ï¼Œæ¨¡å—æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼ŒèŠ‚çœèµ„æº

### ğŸš€ ä½¿ç”¨åœºæ™¯

1. **æ¡ä»¶åŠŸèƒ½æ¨¡å—**
   - æ ¹æ®ç”¨æˆ·æƒé™ã€é…ç½®æˆ–ç¯å¢ƒåŠ è½½ä¸åŒåŠŸèƒ½
   - A/B æµ‹è¯•ä¸­çš„åŠŸèƒ½åˆ†æ”¯

2. **å¤§å‹ä¾èµ–åº“**
   - ä½“ç§¯å¤§ã€åˆå§‹åŒ–æ…¢çš„ç¬¬ä¸‰æ–¹åº“
   - ä»…åœ¨ç‰¹å®šåœºæ™¯ä¸‹ä½¿ç”¨çš„å·¥å…·åº“

3. **æ€§èƒ½ä¼˜åŒ–**
   - å‡å°‘åº”ç”¨å¯åŠ¨æ—¶é—´
   - å»¶è¿Ÿéå…³é”®è·¯å¾„çš„ä»£ç æ‰§è¡Œ

4. **å¹³å°ç‰¹å®šåŠŸèƒ½**
   - æ ¹æ®è¿è¡Œç¯å¢ƒï¼ˆæµè§ˆå™¨/Node.jsï¼‰åŠ è½½ä¸åŒå®ç°

### âš¡ æ€§èƒ½å¯¹æ¯”

```
ä¸ä½¿ç”¨ defer:
â”œâ”€ import æ¨¡å— -> ç«‹å³æ‰§è¡Œæ‰€æœ‰åˆå§‹åŒ–
â”œâ”€ åº”ç”¨å¯åŠ¨ (æ…¢)
â””â”€ ä½¿ç”¨æ¨¡å—åŠŸèƒ½

ä½¿ç”¨ defer:
â”œâ”€ import defer æ¨¡å— -> ä»…åŠ è½½ï¼Œä¸æ‰§è¡Œ
â”œâ”€ åº”ç”¨å¯åŠ¨ (å¿«)
â””â”€ ä½¿ç”¨æ¨¡å—åŠŸèƒ½ -> æ­¤æ—¶æ‰æ‰§è¡Œåˆå§‹åŒ–
```

### ğŸ“ æ³¨æ„äº‹é¡¹

1. **è¿è¡Œç¯å¢ƒè¦æ±‚** âš ï¸
   - è¿™æ˜¯ä¸€ä¸ª **TC39 Stage 2 ææ¡ˆ**ï¼Œç›®å‰å¤„äºå®éªŒé˜¶æ®µ
   - **Node.js æ”¯æŒ**ï¼šéœ€è¦ Node.js v22.12.0+ æˆ– v23.3.0+ å¹¶ä½¿ç”¨ `--experimental-import-defer` æ ‡å¿—// æ·»åŠ æ— æ•ˆ
   - **æµè§ˆå™¨æ”¯æŒ**ï¼šç›®å‰ä¸»æµæµè§ˆå™¨æš‚ä¸æ”¯æŒï¼Œéœ€è¦ä½¿ç”¨æ‰“åŒ…å·¥å…·è½¬è¯‘
   - åªåœ¨ `--module preserve` æˆ– `esnext` æ¨¡å¼ä¸‹å·¥ä½œ
   - æˆ–ä½¿ç”¨æ”¯æŒè¯¥ç‰¹æ€§çš„æ‰“åŒ…å·¥å…·ï¼ˆå¦‚ Webpackã€Vite ç­‰ï¼‰

2. **TypeScript ä¸è½¬è¯‘**
   - TypeScript ä¸ä¼šå°† `import defer` è½¬è¯‘ä¸ºæ—§ç‰ˆæœ¬å…¼å®¹ä»£ç 
   - è¿™åªæ˜¯è¯­æ³•æ£€æŸ¥å’Œç±»å‹æç¤ºï¼Œä¸åšä»£ç è½¬æ¢
   - ç¡®ä¿ç›®æ ‡ç¯å¢ƒæ”¯æŒæ­¤ç‰¹æ€§

3. **æ¨¡å—åŠ è½½ vs æ‰§è¡Œ**
   - æ¨¡å—æ–‡ä»¶ä»ä¼šè¢«åŠ è½½ï¼ˆä»æ–‡ä»¶ç³»ç»Ÿæˆ–ç½‘ç»œï¼‰
   - åªæ˜¯ä»£ç æ‰§è¡Œè¢«å»¶è¿Ÿäº†

### ğŸ”— è¿è¡Œ Demo

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨å®éªŒæ€§ Node.js æ”¯æŒ

éœ€è¦å‡çº§åˆ° Node.js v22.12.0+ æˆ– v23.3.0+ï¼š

```bash
# æ£€æŸ¥å½“å‰ Node.js ç‰ˆæœ¬
node --version

# å¦‚æœç‰ˆæœ¬è¾ƒä½ï¼Œä½¿ç”¨ nvm å‡çº§ï¼ˆWindows ä½¿ç”¨ nvm-windowsï¼‰
nvm install 23
nvm use 23

cd import-defer-demo

# å®‰è£…ä¾èµ–
npm install

# ç¼–è¯‘ TypeScript
npm run build

# ä½¿ç”¨å®éªŒæ€§æ ‡å¿—è¿è¡Œæ¼”ç¤º
# --experimental-import-defer  // æ·»åŠ æ— æ•ˆ
node --experimental-import-defer dist/demo1-without-defer.js
node --experimental-import-defer dist/demo2-with-defer.js
node --experimental-import-defer dist/demo3-conditional-loading.js
```

#### æ–¹å¼äºŒï¼šå­¦ä¹ ä»£ç ï¼ˆæ— éœ€è¿è¡Œï¼‰

å¦‚æœæš‚æ—¶ä¸æƒ³å‡çº§ Node.jsï¼š
1. ç›´æ¥æŸ¥çœ‹æºä»£ç æ–‡ä»¶ï¼Œç†è§£ `import defer` çš„è¯­æ³•å’Œä½¿ç”¨æ–¹å¼
2. é˜…è¯»ä»£ç ä¸­çš„æ³¨é‡Šï¼Œäº†è§£æ‰§è¡Œæµç¨‹çš„åŒºåˆ«
3. å¯¹æ¯” demo1ï¼ˆæ—  deferï¼‰å’Œ demo2ï¼ˆæœ‰ deferï¼‰çš„ä»£ç å·®å¼‚

### ï¿½ å®é™…åº”ç”¨å»ºè®®

ç›®å‰ `import defer` è¿˜ä¸èƒ½ç›´æ¥è¿è¡Œï¼Œä½†ä½ å¯ä»¥ï¼š

1. **å­¦ä¹ æ¦‚å¿µ**ï¼šç†è§£å»¶è¿Ÿæ¨¡å—æ‰§è¡Œçš„æ€æƒ³
2. **å‡†å¤‡ä»£ç **ï¼šæå‰åœ¨ä»£ç ä¸­ä½¿ç”¨è¯¥è¯­æ³•ï¼Œç­‰å¾…è¿è¡Œæ—¶æ”¯æŒ
3. **ä½¿ç”¨æ‰“åŒ…å·¥å…·**ï¼šé…ç½® Webpack/Vite ç­‰æ‰“åŒ…å·¥å…·æ¥è½¬è¯‘
4. **æ›¿ä»£æ–¹æ¡ˆ**ï¼šä½¿ç”¨åŠ¨æ€ `import()` å®ç°ç±»ä¼¼æ•ˆæœï¼ˆè™½ç„¶è¯­ä¹‰ä¸å®Œå…¨ç›¸åŒï¼‰

**åŠ¨æ€ import ä½œä¸ºä¸´æ—¶æ›¿ä»£ï¼š**
```typescript
// å½“å‰å¯è¿è¡Œçš„æ›¿ä»£æ–¹æ¡ˆ
let heavy: typeof import("./heavy-module.js");

async function useHeavyModule() {
  if (!heavy) {
    heavy = await import("./heavy-module.js");
  }
  return heavy.processData("test");
}
```


`import defer` æ˜¯ ECMAScript Stage 2 ææ¡ˆï¼Œè¿˜ä¸æ˜¯æ­£å¼æ ‡å‡†ï¼š

â³ Stage 2 = ææ¡ˆé˜¶æ®µï¼ˆ2024-2026ï¼‰
ğŸ¯ Stage 3 = å€™é€‰æ ‡å‡†ï¼ˆè¿˜æœªåˆ°è¾¾ï¼‰
âœ… Stage 4 = æ­£å¼æ ‡å‡†ï¼ˆé¢„è®¡ 2027+ æ‰å¯èƒ½ï¼‰
åªæœ‰åˆ° Stage 4 åï¼Œæµè§ˆå™¨å’Œ Node.js æ‰ä¼šå¼€å§‹å®ç°ã€‚

### ğŸ“š å‚è€ƒèµ„æº

- [TypeScript 5.9 Release Notes](https://www.typescriptlang.org/docs/handbook/release-notes/typescript-5-9.html#support-for-import-defer)
- [ECMAScript Deferred Module Evaluation Proposal (TC39 Stage 2)](https://github.com/tc39/proposal-defer-import-eval/)
- [Node.js ES Modules](https://nodejs.org/api/esm.html)
